---
title: "Dynamic Linear Models"
subtitle: "FISH 507 â€“ Applied Time Series Analysis"
author: "Mark Scheuerell"
date: "5 Feb 2019"
output:
  ioslides_presentation:
    css: lecture_slides.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(MARSS)
set.seed(123)
data("Nile")

mod_list <- list(B = "identity", U = "zero", Q = matrix("q"),
                 Z = "identity", A = matrix("a"), R = matrix("r"))

fit <- MARSS(matrix(Nile, nrow = 1), mod_list)

```

## Topics for today




## Simple linear regression

Let's begin with a linear regression model

$$
y_i = \alpha + \beta x_i + e_i ~ \text{with} ~ e_i \sim \text{N}(0,\sigma^2)
$$

The index $i$ has no explicit meaning in that shuffling ($y_i,x_i$) pairs has no effect on parameter estimation


## Simple linear regression

We can write the model in matrix form

$$
y_i = \alpha + \beta x_i + e_i \\
\Downarrow \\
y_i = 
\begin{bmatrix}
  1 & x_i
\end{bmatrix}
\begin{bmatrix}
  \alpha \\
  \beta
\end{bmatrix} +
e_i
$$


## Simple linear regression

We can write the model in matrix form

$$
y_i = \alpha + \beta x_i + e_i \\
\Downarrow \\
y_i = 
\begin{bmatrix}
  1 & x_i
\end{bmatrix}
\begin{bmatrix}
  \alpha \\
  \beta
\end{bmatrix} +
e_i \\
\Downarrow \\
y_i = \mathbf{X}^{\top}_i \mathbf{\Theta} + e_i
$$

with $\mathbf{X}^{\top}_i = \begin{bmatrix} 1 & x_i \end{bmatrix}$ and $\mathbf{\Theta} = \begin{bmatrix} \alpha & \beta \end{bmatrix}^{\top}$ 


## Dynamic linear model (DLM)

In a _dynamic_ linear model, the regression parameters change over time, so we write

$$
y_i = \mathbf{X}^{\top}_i \mathbf{\Theta} + e_i ~~~~~~~ \text{(static)}
$$

as

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t ~~~~~~~ \text{(dynamic)}
$$


## Dynamic linear model (DLM)

There are 2 important points here:

$$
y_\boxed{t} = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t
$$

1. Subscript $t$ explicitly acknowledges implicit info in the time ordering of the data in $\mathbf{y}$  


## Dynamic linear model (DLM)

There are 2 important points here:

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_\boxed{t} + e_t
$$

1. Subscript $t$ explicitly acknowledges implicit info in the time ordering of the data in $\mathbf{y}$  

2. The relationship between $\mathbf{y}$ and $\mathbf{X}$ is unique for every $t$


## Constraining a DLM

Close examination of the DLM reveals an apparent problem for parameter estimation

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t
$$


## Constraining a DLM

Close examination of the DLM reveals an apparent problem for parameter estimation

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t
$$

We only have 1 data point per time step (ie, $y_t$ is a scalar)

__Thus, we can only estimate 1 parameter (with no uncertainty)!__


## Constraining a DLM

To address this issue, we'll constrain the regression parameters to be dependent from $t$ to $t+1$

$$
\mathbf{\Theta}_t = \mathbf{G}_t \mathbf{\Theta}_{t-1} + \mathbf{w}_t ~ \text{with} ~ \mathbf{w}_t \sim \text{MVN}(\mathbf{0}, \mathbf{Q})
$$


## Constraining a DLM

In practice, we often make $\mathbf{G}_t$ time invariant 

$$
\mathbf{\Theta}_t = \mathbf{G} \mathbf{\Theta}_{t-1} + \mathbf{w}_t
$$

or assume $\mathbf{G}_t$ is the identity matrix $\mathbf{I}$

$$
\begin{align}
  \mathbf{\Theta}_t &= \mathbf{I} \mathbf{\Theta}_{t-1} + \mathbf{w}_t \\
                    &= \mathbf{\Theta}_{t-1} + \mathbf{w}_t
\end{align}
$$

In the latter case, the parameters follow a random walk over time


## DLM in state-space form

Observation model relates covariates to data

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t
$$

State model determines how parameters "evolve" over time

$$
\mathbf{\Theta}_t = \mathbf{G} \mathbf{\Theta}_{t-1} + \mathbf{w}_t
$$


## Example of a seasonal DLM

$$
y_t = \alpha_t + \beta_t x_t + \gamma_{qtr,t} + e_t \\
\gamma_{qtr,t} = 
\begin{cases}
  \gamma_{1,t} & \text{if } qtr = 1 \\
  \gamma_{2,t} & \text{if } qtr = 2 \\
  \gamma_{3,t} & \text{if } qtr = 3 \\
  \gamma_{4,t} & \text{if } qtr = 4
\end{cases}
$$

If we had quarterly data & wanted only the effects of

1. an intercept (level);  

2. one covariate; and  

3. the current quarter


## Example of a seasonal DLM

$$
y_t = \alpha_t + \beta_t x_t + \gamma_{qtr,t} + e_t \\
\Downarrow \\
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t
$$

with

$$
\mathbf{X}^{\top}_t =
\begin{bmatrix}
  1 & x_t & 1 & 0 & 0 & 0
\end{bmatrix}
$$

and

$$
\mathbf{\Theta}_t^{\top} = 
\begin{bmatrix}
  \alpha_t & \beta_t & \gamma_{1,t} & \gamma_{2,t} & \gamma_{3,t} & \gamma_{4,t}
\end{bmatrix}
$$


## Obtaining seasonal effect

$$
y_t = 
\begin{bmatrix}
  1 & x_t & 1 & 0 & 0 & 0
\end{bmatrix} 
\begin{bmatrix}
  \alpha_t \\ \beta_t \\ \gamma_{1,t} \\ \gamma_{2,t} \\ \gamma_{3,t} \\ \gamma_{4,t}
\end{bmatrix}
+ e_t
$$

$$
y_t = \alpha_t + \beta_t x_t + \gamma_{1,t} + e_t
$$

But this gives the effect of $\gamma_{1,t}$ at every time $t$


## Example of non-diagonal $\mathbf{G}$

We can use a non-diagonal $\mathbf{G}$ to get the correct quarter effect

$$
\mathbf{G} = 
\begin{bmatrix}
  1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 1 \\
  0 & 0 & 1 & 0 & 0 & 0
\end{bmatrix}
~ \text{and} ~~
\mathbf{\Theta}_t = 
\begin{bmatrix}
  \alpha_t \\ \beta_t \\ \gamma_{i,t} \\ \gamma_{j,t} \\ \gamma_{k,t} \\ \gamma_{l,t}
\end{bmatrix}
$$


## Evolving parameters | $t = 5$

$$
\underbrace{\begin{bmatrix}
  \alpha_{5} \\ \beta_{5} \\ \gamma_{1,5} \\ \gamma_{2,5} \\ \gamma_{3,5} \\ \gamma_{4,5}
\end{bmatrix}}_{\mathbf{\Theta}_{5}} =
\underbrace{\begin{bmatrix}
  1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 1 \\
  0 & 0 & 1 & 0 & 0 & 0
\end{bmatrix}}_{\mathbf{G}}
\underbrace{\begin{bmatrix}
  \alpha_{4} \\ \beta_{4} \\ \gamma_{4,4} \\ \gamma_{1,4} \\ \gamma_{2,4} \\ \gamma_{3,4}
\end{bmatrix}}_{\mathbf{\Theta}_{4}} + 
\underbrace{\begin{bmatrix}
  w_{\alpha,5} \\ w_{\beta,5}  \\ w_{\gamma_1,5}  \\ w_{\gamma_2,5} \\ w_{\gamma_3,5} \\ w_{\gamma_4,5}
\end{bmatrix}}_{\mathbf{w}_{5}}
$$


## Evolving parameters | $t = 6$

$$
\underbrace{\begin{bmatrix}
  \alpha_{6} \\ \beta_{6} \\ \gamma_{2,6} \\ \gamma_{3,6} \\ \gamma_{4,6} \\ \gamma_{1,6}
\end{bmatrix}}_{\mathbf{\Theta}_{6}} =
\underbrace{\begin{bmatrix}
  1 & 0 & 0 & 0 & 0 & 0 \\
  0 & 1 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 1 & 0 & 0 \\
  0 & 0 & 0 & 0 & 1 & 0 \\
  0 & 0 & 0 & 0 & 0 & 1 \\
  0 & 0 & 1 & 0 & 0 & 0
\end{bmatrix}}_{\mathbf{G}}
\underbrace{\begin{bmatrix}
  \alpha_{5} \\ \beta_{5} \\ \gamma_{1,5} \\ \gamma_{2,5} \\ \gamma_{3,5} \\ \gamma_{4,5}
\end{bmatrix}}_{\mathbf{\Theta}_{5}} + 
\underbrace{\begin{bmatrix}
  w_{\alpha,6} \\ w_{\beta,6}  \\ w_{\gamma_2,6}  \\ w_{\gamma_3,6} \\ w_{\gamma_4,6} \\ w_{\gamma_1,6}
\end{bmatrix}}_{\mathbf{w}_{6}}
$$


## Obtaining seasonal effect

$$
y_6 = 
\begin{bmatrix}
  1 & x_6 & 1 & 0 & 0 & 0
\end{bmatrix} 
\begin{bmatrix}
  \alpha_6 \\ \beta_6 \\ \gamma_{2,6} \\ \gamma_{3,6} \\ \gamma_{4,6} \\ \gamma_{1,6}
\end{bmatrix}
+ e_6
$$

$$
y_6 = \alpha_6 + \beta_6 x_6 + \gamma_{2,6} + e_6
$$


## DLM in MARSS notation | Full state-space form

$$
y_t = \mathbf{X}^{\top}_t \mathbf{\Theta}_t + e_t \\
\mathbf{\Theta}_t = \mathbf{G} \mathbf{\Theta}_{t-1} + \mathbf{w}_t \\
\Downarrow \\
y_t = \mathbf{Z}_t \mathbf{x}_t + v_t \\
\mathbf{x}_t = \mathbf{B} \mathbf{x}_{t-1} + \mathbf{w}_t
$$


## Contrast in covariate effects

__Note__: DLMs include covariate effect in the observation eqn much differently than other forms of MARSS models

DLM: $\mathbf{Z}$ is covariates, $\mathbf{x}$ is parameters 

$$
y_t = \boxed{\mathbf{Z}_t \mathbf{x}_t} + v_t \\
$$

Others: $\mathbf{d}$ is covariates, $\mathbf{D}$ is parameters

$$
y_t = \mathbf{Z}_t \mathbf{x}_t + \boxed{\mathbf{D} \mathbf{d}_t} +v_t \\
$$


## Other forms of DLMs

The regression model is but one type

Others include:

* stochastic "level" (intercept)

* stochastic "growth" (trend, bias)

* seasonal effects (fixed, harmonic)


## The most simple DLM | Stochastic level

$$
y_t = \alpha_t + e_t \\
\alpha_t = \alpha_{t-1} + w_t
$$


## The most simple DLM | Stochastic level = random walk with obs error

$$
y_t = \alpha_t + e_t \\
\alpha_t = \alpha_{t-1} + w_t \\
\Downarrow \\
y_t = x_t + v_t \\
x_t = x_{t-1} + w_t
$$


## Ex of stochastic level model

```{r}
data("Nile")

par(mai = c(0.9, 0.9, 0.1, 0.1), omi = c(0, 0, 0, 0))

plot.ts(Nile, las = 1,
        xlab = "Year", ylab = "Flow of the River Nile")
```


## Ex of stochastic level model


```{r}
par(mai = c(0.9, 0.9, 0.1, 0.1), omi = c(0, 0, 0, 0))

plot.ts(Nile, las = 1, lwd = 2,
        xlab = "Year", ylab = "Flow of the River Nile")
lines(seq(start(Nile)[1], end(Nile)[1]),
       lwd = 2, t(fit$states), col = "blue")
lines(seq(start(Nile)[1], end(Nile)[1]), t(fit$states + 2*fit$states.se),
       lwd = 2, lty = "dashed", col = "blue")
lines(seq(start(Nile)[1], end(Nile)[1]), t(fit$states - 2*fit$states.se),
       lwd = 2, lty = "dashed", col = "blue")
```




